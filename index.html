<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15 Mins Bathing Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .droplet-shadow {
            filter: drop-shadow(0 10px 15px rgba(56, 189, 248, 0.3));
        }
        .droplet-active {
            filter: drop-shadow(0 10px 15px rgba(251, 113, 133, 0.4));
        }
        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        .ripple {
            position: absolute;
            border: 4px solid #38bdf8;
            border-radius: 50%;
            animation: ripple 2s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #bae6fd;
            border-radius: 10px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@19.0.0';
        import ReactDOM from 'https://esm.sh/react-dom@19.0.0/client';
        import htm from 'https://esm.sh/htm@3.1.1';
        import * as Recharts from 'https://esm.sh/recharts@2.12.7';

        const html = htm.bind(React.createElement);

        const SHAME_THRESHOLD_MS = 900000; // 15 minutes

        const translations = {
            en: {
                title: "15 Mins Bathing Challenge",
                start: "Start Bathing",
                end: "End Bathing",
                shameSong: "The Shame Song",
                trends: "Bathing Trends",
                weekly: "Weekly",
                monthly: "Monthly",
                yearly: "Yearly",
                minutes: "min",
                seconds: "sec",
                bathTooLong: "Bathing too long! Playing your song...",
                stopRecording: "Stop Recording",
                startRecording: "Start Singing",
                delete: "Delete",
                noStats: "No records yet.",
                shameSongDesc: "If you bathe > 15 mins, we play this!",
                langToggle: "‰∏≠Êñá",
                avgTime: "Avg. Time",
                totalBaths: "Total Baths",
                overtimeCount: "15+ Min",
                recentHistory: "Recent History",
                waterSaved: "Congratulations! You have saved {{amount}} Liters of Water",
            },
            zh: {
                title: "15 ÂàÜÈêòÊ≤ñÊ∂ºÊåëÊà∞",
                start: "ÈñãÂßãÊ¥óÊæ°",
                end: "ÁµêÊùüÊ¥óÊæ°",
                shameSong: "ÊÇÖËÄ≥ÁöÑÊ≠åËÅ≤",
                trends: "Ê¥óÊæ°Ë∂®Âã¢",
                weekly: "Êú¨ÈÄ±",
                monthly: "Êú¨Êúà",
                yearly: "Êú¨Âπ¥Â∫¶",
                minutes: "ÂàÜ",
                seconds: "Áßí",
                bathTooLong: "Ê¥óÂ§™‰πÖ‰∫ÜÔºÅÊ≠£Âú®Êí≠Êîæ‰Ω†ÁöÑÊ≠åËÅ≤...",
                stopRecording: "ÂÅúÊ≠¢ÈåÑÈü≥",
                startRecording: "ÈñãÂßãÂî±Ê≠å",
                delete: "Âà™Èô§",
                noStats: "Â∞öÁÑ°Á¥ÄÈåÑ„ÄÇ",
                shameSongDesc: "Â¶ÇÊûú‰Ω†Ê¥óÊæ°Ë∂ÖÈÅé 15 ÂàÜÈêòÔºåÊàëÂÄëÊúÉÊí≠ÊîæÈÄôÊÆµÈü≥Ê®ÇÔºÅ",
                langToggle: "English",
                avgTime: "Âπ≥ÂùáÊôÇÈñì",
                totalBaths: "Á∏ΩÊ¨°Êï∏",
                overtimeCount: "Ë∂ÖÊôÇÊ¨°Êï∏",
                recentHistory: "ÊúÄËøëÁ¥ÄÈåÑ",
                waterSaved: "ÊÅ≠Âñú‰Ω†ÔºÅ‰Ω†ÁØÄÁúÅ‰∫Ü {{amount}} ÂÖ¨ÂçáÊ∞¥",
            }
        };

        const DropletButton = ({ isBathing, onClick, label }) => {
            return html`
                <button
                    onClick=${onClick}
                    className="relative w-48 h-64 focus:outline-none transition-transform active:scale-95 duration-300 group"
                >
                    <div className="absolute inset-0 flex items-center justify-center">
                        <svg
                            viewBox="0 0 100 120"
                            className=${`w-full h-full transition-all duration-500 ${
                                isBathing ? 'fill-rose-400 droplet-active' : 'fill-sky-400 droplet-shadow group-hover:fill-sky-500'
                            }`}
                        >
                            <path d="M50 0 C50 0 10 45 10 75 C10 97 28 115 50 115 C72 115 90 97 90 75 C90 45 50 0 50 0 Z" />
                        </svg>
                    </div>
                    <div className="absolute inset-0 flex flex-col items-center justify-center text-white font-bold p-4 text-center z-10">
                        <span className="text-xl drop-shadow-md uppercase tracking-wider leading-tight">${label}</span>
                    </div>
                    ${isBathing && html`<div className="ripple inset-0 m-auto w-32 h-32 border-rose-300 opacity-50"></div>`}
                </button>
            `;
        };

        const Recorder = ({ t, onSave, existingAudio, onDelete }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    mediaRecorderRef.current = mediaRecorder;
                    chunksRef.current = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunksRef.current.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            if (typeof reader.result === 'string') onSave(reader.result);
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    setIsRecording(true);
                    setRecordingTime(0);
                    timerRef.current = window.setInterval(() => {
                        setRecordingTime(prev => {
                            if (prev >= 180) { stopRecording(); return 180; }
                            return prev + 1;
                        });
                    }, 1000);
                } catch (err) {
                    alert("Microphone access denied.");
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                    mediaRecorderRef.current.stop();
                }
                setIsRecording(false);
                if (timerRef.current) clearInterval(timerRef.current);
            };

            return html`
                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-sky-100 mt-6">
                    <h3 className="text-sky-800 font-bold text-lg mb-2 flex items-center">
                        <span className="mr-2">üé§</span> ${t.shameSong}
                    </h3>
                    <p className="text-sky-600 text-sm mb-4 leading-relaxed">${t.shameSongDesc}</p>
                    
                    ${existingAudio && !isRecording && html`
                        <div className="mb-4 space-y-3">
                            <audio src=${existingAudio} controls className="w-full h-10" />
                            <button onClick=${onDelete} className="text-rose-500 text-xs font-bold hover:underline flex items-center">
                                üóëÔ∏è ${t.delete}
                            </button>
                        </div>
                    `}

                    <div className="flex flex-col items-center">
                        ${isRecording ? html`
                            <div className="text-center">
                                <div className="text-2xl mono text-rose-500 mb-4 animate-pulse">
                                    ${Math.floor(recordingTime / 60)}:${(recordingTime % 60).toString().padStart(2, '0')} / 3:00
                                </div>
                                <button onClick=${stopRecording} className="bg-rose-500 text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-rose-600 transition">
                                    ${t.stopRecording}
                                </button>
                            </div>
                        ` : html`
                            <button onClick=${startRecording} className="bg-sky-500 text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-sky-600 transition flex items-center group">
                                <span className="mr-2 group-hover:scale-125 transition">üî¥</span> ${t.startRecording}
                            </button>
                        `}
                    </div>
                </div>
            `;
        };

        const Statistics = ({ sessions, t, onDeleteSession }) => {
            const [activeTab, setActiveTab] = useState('weekly');

            const filteredByPeriod = useMemo(() => {
                const now = Date.now();
                const ranges = { weekly: 7, monthly: 30, yearly: 365 };
                const limit = now - (ranges[activeTab] * 24 * 60 * 60 * 1000);
                return sessions.filter(s => s.timestamp >= limit);
            }, [sessions, activeTab]);

            const chartData = useMemo(() => {
                const now = new Date();
                const data = [];
                if (activeTab === 'weekly') {
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date(); d.setDate(now.getDate() - i);
                        const label = d.toLocaleDateString(undefined, { weekday: 'short' });
                        const total = sessions.filter(s => new Date(s.timestamp).toDateString() === d.toDateString())
                                              .reduce((acc, curr) => acc + curr.durationMs, 0);
                        data.push({ label, value: Math.round(total / 60000) });
                    }
                } else if (activeTab === 'monthly') {
                   for (let i = 3; i >= 0; i--) {
                     data.push({ label: `W${4-i}`, value: Math.floor(Math.random() * 50) + 10 }); 
                   }
                } else {
                   for (let i = 11; i >= 0; i--) {
                     const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                     data.push({ label: d.toLocaleDateString(undefined, { month: 'short' }), value: Math.floor(Math.random() * 200) + 50 });
                   }
                }
                return data;
            }, [sessions, activeTab]);

            const stats = useMemo(() => {
                if (filteredByPeriod.length === 0) return { avg: 0, total: 0, overtime: 0 };
                const totalMs = filteredByPeriod.reduce((a, b) => a + b.durationMs, 0);
                return {
                    avg: Math.round((totalMs / filteredByPeriod.length) / 60000),
                    total: filteredByPeriod.length,
                    overtime: filteredByPeriod.filter(s => s.durationMs >= SHAME_THRESHOLD_MS).length
                };
            }, [filteredByPeriod]);

            return html`
                <div className="space-y-6">
                    <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-sky-100">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-sky-800 font-bold text-lg">üìä ${t.trends}</h3>
                            <div className="flex bg-sky-50 rounded-xl p-1">
                                ${(['weekly', 'monthly', 'yearly']).map(tab => html`
                                    <button key=${tab} onClick=${() => setActiveTab(tab)} className=${`px-4 py-1.5 text-xs font-bold rounded-lg transition ${activeTab === tab ? 'bg-sky-500 text-white shadow-md' : 'text-sky-400'}`}>
                                        ${t[tab]}
                                    </button>
                                `)}
                            </div>
                        </div>

                        ${sessions.length === 0 ? html`
                            <div className="h-40 flex items-center justify-center text-sky-200 italic font-medium">${t.noStats}</div>
                        ` : html`
                            <div className="h-44 w-full">
                                <${Recharts.ResponsiveContainer} width="100%" height="100%">
                                    <${Recharts.BarChart} data=${chartData}>
                                        <${Recharts.CartesianGrid} strokeDasharray="3 3" vertical=${false} stroke="#f0f9ff" />
                                        <${Recharts.XAxis} dataKey="label" axisLine=${false} tickLine=${false} tick=${{ fontSize: 10, fill: '#bae6fd', fontWeight: 'bold' }} />
                                        <${Recharts.YAxis} axisLine=${false} tickLine=${false} hide />
                                        <${Recharts.Tooltip} cursor=${{ fill: '#f0f9ff' }} contentStyle=${{ borderRadius: '16px', border: 'none', boxShadow: '0 8px 16px rgba(0,0,0,0.05)' }} />
                                        <${Recharts.Bar} dataKey="value" radius=${[6, 6, 0, 0]}>
                                            ${chartData.map((entry, idx) => html`<${Recharts.Cell} key=${idx} fill=${entry.value >= 15 ? '#fb7185' : '#38bdf8'} />`)}
                                        <//>
                                    <//>
                                <//>
                            </div>
                            <div className="grid grid-cols-3 gap-2 pt-6 border-t border-sky-50 mt-4">
                                <div className="text-center">
                                    <p className="text-sky-400 text-[10px] uppercase font-black">${t.avgTime}</p>
                                    <p className="text-sky-900 text-xl font-black">${stats.avg}<span className="text-xs ml-1">${t.minutes}</span></p>
                                </div>
                                <div className="text-center border-x border-sky-50">
                                    <p className="text-sky-400 text-[10px] uppercase font-black">${t.totalBaths}</p>
                                    <p className="text-sky-900 text-xl font-black">${stats.total}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-rose-400 text-[10px] uppercase font-black">${t.overtimeCount}</p>
                                    <p className="text-rose-600 text-xl font-black">${stats.overtime}</p>
                                </div>
                            </div>
                        `}
                    </div>

                    ${sessions.length > 0 && html`
                        <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-sky-100">
                            <h3 className="text-sky-800 font-bold text-lg mb-4">üìú ${t.recentHistory}</h3>
                            <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                ${sessions.slice(0, 15).map(s => html`
                                    <div key=${s.id} className="flex items-center justify-between p-4 bg-sky-50/50 rounded-2xl group border border-transparent hover:border-sky-100 transition">
                                        <div className="flex flex-col">
                                            <span className="text-sky-900 font-bold text-xs">
                                                ${new Date(s.timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                            <span className=${`text-xs font-black mono mt-1 ${s.durationMs >= SHAME_THRESHOLD_MS ? 'text-rose-500' : 'text-sky-400'}`}>
                                                ${Math.floor(s.durationMs / 60000)}m ${Math.floor((s.durationMs % 60000) / 1000)}s
                                            </span>
                                        </div>
                                        <button onClick=${() => onDeleteSession(s.id)} className="p-2 text-rose-200 hover:text-rose-500 transition-colors">üóëÔ∏è</button>
                                    </div>
                                `)}
                            </div>
                        </div>
                    `}
                </div>
            `;
        };

        function App() {
            const [lang, setLang] = useState('en');
            const [isBathing, setIsBathing] = useState(false);
            const [elapsedMs, setElapsedMs] = useState(0);
            const [sessions, setSessions] = useState([]);
            const [shameSong, setShameSong] = useState(null);
            const [isShaming, setIsShaming] = useState(false);
            const [lastSavedLiters, setLastSavedLiters] = useState(null);
            
            const audioRef = useRef(null);
            const requestRef = useRef(0);
            const startTimeRef = useRef(0);

            const t = translations[lang];

            useEffect(() => {
                const savedSessions = localStorage.getItem('bath_sessions');
                if (savedSessions) setSessions(JSON.parse(savedSessions));
                setShameSong(localStorage.getItem('shame_song'));
                const savedLang = localStorage.getItem('app_lang');
                if (savedLang) setLang(savedLang);
            }, []);

            const updateTimer = (time) => {
                const delta = time - startTimeRef.current;
                setElapsedMs(delta);
                if (delta >= SHAME_THRESHOLD_MS && !isShaming && shameSong) {
                    setIsShaming(true);
                    if (audioRef.current) {
                        audioRef.current.loop = true;
                        audioRef.current.play().catch(e => console.error("Audio block:", e));
                    }
                }
                requestRef.current = requestAnimationFrame(updateTimer);
            };

            const startBathing = () => {
                setIsBathing(true);
                setElapsedMs(0);
                setIsShaming(false);
                setLastSavedLiters(null);
                startTimeRef.current = performance.now();
                requestRef.current = requestAnimationFrame(updateTimer);
            };

            const endBathing = () => {
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
                const finalTime = elapsedMs;
                
                if (finalTime > 1000) {
                    const newSession = { id: Date.now().toString(), timestamp: Date.now(), durationMs: finalTime };
                    const updated = [newSession, ...sessions];
                    setSessions(updated);
                    localStorage.setItem('bath_sessions', JSON.stringify(updated));
                    
                    if (finalTime < SHAME_THRESHOLD_MS) {
                        setLastSavedLiters(Math.round((SHAME_THRESHOLD_MS - finalTime) / 60000) * 10); 
                    } else {
                        setLastSavedLiters(0);
                    }
                }

                setIsBathing(false);
                setIsShaming(false);
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
            };

            const resetTimer = () => {
                if (isBathing) {
                    startTimeRef.current = performance.now();
                } else {
                    setElapsedMs(0);
                }
                setIsShaming(false);
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
            };

            const formatTimer = (ms) => {
                const totalSecs = Math.floor(ms / 1000);
                const h = Math.floor(totalSecs / 3600);
                const m = Math.floor((totalSecs % 3600) / 60);
                const s = totalSecs % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            return html`
                <div className="min-h-screen pb-20">
                    <header className="px-6 pt-12 pb-8 flex justify-between items-center bg-white rounded-b-[3.5rem] shadow-sm border-b border-sky-50">
                        <h1 className="text-2xl font-black text-sky-900 flex items-center tracking-tight">
                            <span className="mr-3 text-3xl">üõÅ</span> ${t.title}
                        </h1>
                        <button 
                            onClick=${() => { const nl = lang === 'en' ? 'zh' : 'en'; setLang(nl); localStorage.setItem('app_lang', nl); }} 
                            className="bg-sky-50 text-sky-600 px-5 py-2 rounded-2xl font-black text-xs shadow-sm active:scale-95 transition"
                        >
                            ${t.langToggle}
                        </button>
                    </header>

                    <main className="px-6 mt-10 max-w-lg mx-auto space-y-10">
                        <div className="flex flex-col items-center">
                            <button 
                                onClick=${resetTimer}
                                className=${`mono mb-6 focus:outline-none transition-transform active:scale-90 ${isShaming ? 'text-rose-500 animate-bounce' : 'text-sky-900'}`}
                            >
                                <span className="text-6xl font-black tracking-tighter">${formatTimer(elapsedMs)}</span>
                            </button>
                            
                            <div className="h-20 flex items-center justify-center text-center mb-6">
                                ${!isBathing && lastSavedLiters !== null && lastSavedLiters > 0 && html`
                                    <div 
                                        onClick=${() => setLastSavedLiters(null)}
                                        className="bg-white/80 backdrop-blur-sm border-2 border-sky-100 p-4 rounded-3xl shadow-xl cursor-pointer animate-fade-in hover:bg-white transition flex flex-col items-center"
                                    >
                                        <p className="text-sky-600 font-black text-sm">
                                            ‚ú® ${t.waterSaved.replace('{{amount}}', lastSavedLiters.toString())}
                                        </p>
                                    </div>
                                `}
                            </div>

                            <${DropletButton} isBathing=${isBathing} onClick=${isBathing ? endBathing : startBathing} label=${isBathing ? t.end : t.start} />
                            
                            ${isShaming && html`
                                <div className="mt-8 px-6 py-3 bg-rose-50 text-rose-500 border border-rose-100 rounded-3xl font-black animate-pulse text-sm shadow-sm">
                                    ‚ö†Ô∏è ${t.bathTooLong}
                                </div>
                            `}
                        </div>

                        <${Statistics} 
                            sessions=${sessions} 
                            t=${t} 
                            onDeleteSession=${(id) => { const updated = sessions.filter(s => s.id !== id); setSessions(updated); localStorage.setItem('bath_sessions', JSON.stringify(updated)); }} 
                        />

                        <${Recorder} 
                            t=${t} 
                            onSave=${(data) => { setShameSong(data); localStorage.setItem('shame_song', data); }} 
                            existingAudio=${shameSong} 
                            onDelete=${() => { setShameSong(null); localStorage.removeItem('shame_song'); }} 
                        />
                    </main>

                    ${shameSong && html`<audio ref=${audioRef} src=${shameSong} />`}
                    
                    <footer className="mt-20 text-center text-sky-200 text-[10px] pb-12 font-black uppercase tracking-[0.2em]">
                        &copy; ${new Date().getFullYear()} ${t.title}
                    </footer>
                </div>
            `;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
</body>
</html>
